rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() { return request.auth != null; }
    
    // Helper function to check if user is assigned to warranty
    function isAssignedToWarranty() {
      return isAuthed() && 
        resource.data.assignedTo != null &&
        request.auth.uid in resource.data.assignedTo;
    }
    
    // Helper function to check if user created the warranty
    function isWarrantyCreator() {
      return isAuthed() && 
        resource.data.createdBy != null &&
        request.auth.uid == resource.data.createdBy;
    }
    
    // Users collection - allow role management for admins
    match /users/{userId} {
      allow read: if true;
      // Users can update their own profile
      // Authenticated users can update any user document (for role management)
      // Access is already restricted by Advanced Features Dashboard to authorized emails
      allow create: if isAuthed();
      allow update: if isAuthed();
      allow delete: if isAuthed();
    }
    
    match /leads/{leadId} {
      allow read: if true;
      allow write: if isAuthed();
      match /{subcollection=**}/{docId} {
        allow read: if true;
        allow write: if isAuthed();
      }
    }
    
    match /clients/{clientId} {
      allow read: if true;
      allow write: if isAuthed();
      match /{subcollection=**}/{docId} {
        allow read: if true;
        allow write: if isAuthed();
      }
    }
    
    //New block for projects
    match /projects/{projectId} {
      allow read: if true;
      allow write: if isAuthed();
      match /{subcollection=**}/{docId} {
        allow read: if true;
        allow write: if isAuthed();
      }
    }
    
    // WARRANTIES COLLECTION
    // Access is restricted to Tatco roles at the application level (navigation/module system)
    // Rules here provide additional security at the database level
    match /warranties/{warrantyId} {
      // Read: Authenticated users can read warranties
      // (UI already restricts to Tatco roles via module access)
      allow read: if isAuthed();
      
      // Create: Authenticated users can create warranties
      // (UI restricts to Tatco roles only)
      allow create: if isAuthed();
      
      // Update: User must be the creator OR assigned to the warranty
      allow update: if isAuthed() && 
        (isWarrantyCreator() || isAssignedToWarranty());
      
      // Delete: Any admin or Tatco user can delete warranties
      // OR user must be the creator OR assigned to the warranty
      allow delete: if isAuthed() && (
        // Check if user is admin or has Tatco role by reading user document
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'tatco_user' ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'tatco_user_profit_sharing' ||
         (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role is list &&
          ('admin' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role ||
           'tatco_user' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role ||
           'tatco_user_profit_sharing' in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role))) ||
        // OR user is creator or assigned
        isWarrantyCreator() || isAssignedToWarranty()
      );
      
      // Subcollections: updates and attachments
      match /updates/{updateId} {
        // Read: Authenticated users can read updates
        allow read: if isAuthed();
        // Create: Authenticated users can add updates
        // (UI restricts to Tatco roles)
        allow create: if isAuthed();
        // Update/Delete: Only creator of the update can modify it
        allow update, delete: if isAuthed() && 
          request.auth.uid == resource.data.createdBy;
      }
      
      match /attachments/{attachmentId} {
        // Use same rules as other entity attachments (files/folders)
        allow read: if isAuthed();
        allow write: if isAuthed();
        match /{subcollection=**}/{docId} {
          allow read: if isAuthed();
          allow write: if isAuthed();
        }
      }
      
      // Files subcollection (for attachments)
      match /files/{fileId} {
        allow read: if isAuthed();
        allow write: if isAuthed();
      }

      // Activities subcollection (for unified activity timeline)
      match /activities/{activityId} {
        // Authenticated users can read and write activities for warranties
        // UI restricts access to Tatco roles; this enforces auth at DB level
        allow read: if isAuthed();
        allow write: if isAuthed();
      }

      // Sections subcollection (for notification membership lookups)
      match /sections/{sectionId} {
        allow read: if isAuthed();
        allow write: if isAuthed();
      }
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Authenticated users can create notifications (for themselves or others)
      allow create: if request.auth != null;
      
      // Users can only update their own notifications (mark as read, etc.)
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.userId &&
        request.resource.data.userId == resource.data.userId;
      
      // Users can only delete their own notifications
      allow delete: if request.auth != null && 
        request.auth.uid == resource.data.userId;
    }
    
    // Profit Sharing agreement settings
    match /profitSharing/{document=**} {
      allow read: if true;
      allow write: if isAuthed();
    }
    
    // Profit Sharing Plans collection
    match /profitSharingPlans/{planId} {
      allow read: if true;
      allow write: if isAuthed();
    }
    
    // Stakeholders collection
    match /stakeholders/{stakeholderId} {
      allow read: if true;
      allow write: if isAuthed();
    }
    // Valuations collection
    match /valuations/{valuationId} {
      allow read: if true;
      allow write: if isAuthed();
    }
    // Companies collection
    match /companies/{companyId} {
      allow read: if true;
      allow write: if isAuthed();
    }
    // Access To Profit Sharing
    match /profitSharingAccess/{accessId} {
      allow read: if true;
      allow write: if isAuthed();
    }
  }
}
